\newpage
\appendix
\section{Mobile app developed using Android SDK} \label{App:AppendixA}
% the \\ insures the section title is centered below the phrase: AppendixA

\emph{AndroidHardware.java}
\begin{lstlisting}
package pollux.trialbee.com.pollux;

import android.app.Activity;
import android.bluetooth.BluetoothAdapter;
import android.bluetooth.BluetoothDevice;
import android.content.Context;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.net.Uri;
import android.os.Build;
import android.os.Environment;
import android.provider.MediaStore;
import android.util.Base64;
import android.util.Log;

import org.json.JSONException;
import org.json.JSONObject;

import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.Set;


/**
 * Created by dauvid on 2015-02-17.
 */
public class AndroidHardware {
    private static final String TAG="AndroidHardware";

    public static File requestImageFile() {
        String fileName = "tempPhoto";
        File storageDir = Environment.getExternalStoragePublicDirectory(Environment.DIRECTORY_PICTURES);
        File photoFile = null;
        try {
            photoFile = File.createTempFile(fileName, ".jpg", storageDir);
        } catch (IOException e) {
            e.printStackTrace();
        }
        return photoFile;
    }

    public static String getDeviceInfo(Context context) throws JSONException {
        Log.d(TAG, "getDeviceInfo");

        JSONObject jsonObject = new JSONObject();
        PackageManager packageManager = context.getPackageManager();
        jsonObject.put("camera", packageManager.hasSystemFeature(PackageManager.FEATURE_CAMERA_ANY));
        jsonObject.put("bluetooth", packageManager.hasSystemFeature(PackageManager.FEATURE_BLUETOOTH));
        jsonObject.put("accelerometer", packageManager.hasSystemFeature(PackageManager.FEATURE_SENSOR_ACCELEROMETER));
        return jsonObject.toString();
    }

    public static boolean isBluetoothActivated() {
        return BluetoothAdapter.getDefaultAdapter().isEnabled();
    }
    public static void discoverBluetoothDevices() {
        BluetoothAdapter.getDefaultAdapter().startDiscovery();
    }

}
\end{lstlisting}
\emph{Bridge.java}
\begin{lstlisting}
package pollux.trialbee.com.pollux;

import android.content.Context;
import android.content.Intent;
import android.location.Location;
import android.location.LocationManager;
import android.net.Uri;
import android.provider.MediaStore;
import android.util.Log;
import android.webkit.WebView;
import android.widget.Toast;

import org.json.JSONException;
import org.json.JSONObject;

/**
 * Created by dauvid on 2015-02-26.
 */
public class Bridge {
    private Context context;
    private MainActivity mActivity;
    private WebViewDataSender webViewDataSender;
    private static final String TAG = "Bridge";

    public Bridge(Context context) {
        this.context = context;
        mActivity = (MainActivity) context;
        webViewDataSender = new WebViewDataSender(this, (WebView) mActivity.findViewById(R.id.webView));
    }

    public void requestCamera(String callback) {
        Log.d(TAG, "requestCamera");

        // Create a new intent
        Intent imageIntent = IntentFactory.createCameraIntent(context);

        // Retrieve filepath to photo being captured
        Uri photoFileUri = (Uri) imageIntent.getExtras().get(MediaStore.EXTRA_OUTPUT);

        // Create callback method
        Callback imageCallback = new ImageCallback(this, photoFileUri, callback);

        // Send intent to mainActivity for processing
        mActivity.processIntent(imageIntent, imageCallback);
    }

    public void requestImage(String callback) {
        Log.d(TAG, "requestImage");

        // Create a new intent
        Intent imageIntent = IntentFactory.createImageIntent(context);

        // Create callback for the intent
        Callback imagePickCallback = new ImagePickCallback(this, context, callback);

        // Send intent to mainActivity for processing
        mActivity.processIntent(imageIntent, imagePickCallback);
    }

    public void getGeolocation(String callback) {
        LocationManager locationManager = (LocationManager) context.getSystemService(Context.LOCATION_SERVICE);
        String locationProvider = LocationManager.NETWORK_PROVIDER;
        Location lastKnownLocation = locationManager.getLastKnownLocation(locationProvider);

        // Create JSONObject containing longitude and latitude
        JSONObject locationJSON = new JSONObject();
        try {
            locationJSON.put("longitude", Double.toString(lastKnownLocation.getLongitude()));
            locationJSON.put("latitude", Double.toString(lastKnownLocation.getLatitude()));
        } catch (JSONException e) {
            e.printStackTrace();
        }
        processCallback(callback, locationJSON.toString());
    }

    public void processCallback(String callback, String argument) {
        webViewDataSender.sendData(callback, argument);
    }


}
\end{lstlisting}
\emph{Callback.java}
\begin{lstlisting}
package pollux.trialbee.com.pollux;

import android.content.Intent;

public interface Callback {
    public void done(int requestCode, int resultCode, Intent data);
}
\end{lstlisting}

\emph{ImageCallback.java}
\begin{lstlisting}
package pollux.trialbee.com.pollux;

import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.net.Uri;
import android.os.Bundle;
import android.provider.MediaStore;
import android.util.Base64;
import android.util.Log;

import java.io.ByteArrayOutputStream;
import java.io.File;

/**
 * Created by philip on 2015-02-26.
 */
public class ImageCallback implements Callback {
    private Uri photoFileUri;
    private Bridge bridge;
    private static final String TAG = "ImageCallback";
    private String callbackName;

    public ImageCallback(Bridge bridge, Uri photoFileUri, String callbackName){
        this.bridge = bridge;
        this.photoFileUri = photoFileUri;
        this.callbackName = callbackName;
    }

    @Override
    public void done(int requestCode, int resultCode, Intent data) {
        Log.d(TAG, "done");
        bridge.processCallback(callbackName, getImageBase64(photoFileUri));
    }

    private String getImageBase64(Uri uri) {
        Log.d(TAG, "getImageBase64");
        // Get photo file as bitMap
        File photoFile = new File(uri.getPath());
        String filePath = photoFile.getAbsolutePath();
        Log.d(TAG, "filePath to image is: " + filePath);
        Bitmap bm = BitmapFactory.decodeFile(filePath);

        // Convert bitmap to byte array
        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        bm.compress(Bitmap.CompressFormat.JPEG, 100, baos); //bm is the bitmap object
        byte[] b = baos.toByteArray();
        return Base64.encodeToString(b, Base64.DEFAULT);
    }
}
\end{lstlisting}
\emph{ImagePickCallback.java}
\begin{lstlisting}
package pollux.trialbee.com.pollux;

import android.content.Context;
import android.content.Intent;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.net.Uri;
import android.util.Base64;
import android.util.Log;

import java.io.ByteArrayOutputStream;
import java.io.File;
import java.io.FileNotFoundException;
import java.io.InputStream;

/**
 * Created by dauvid on 2015-03-23.
 */
public class ImagePickCallback implements Callback {
    private Bridge bridge;
    private static final String TAG = "ImagePickCallback";
    private String callbackName;
    private Context context;
    public ImagePickCallback(Bridge bridge,Context context, String callbackName){
        this.bridge = bridge;
        this.callbackName = callbackName;
        this.context = context;
    }

    @Override
    public void done(int requestCode, int resultCode, Intent data) {
        Log.d(TAG, "hej");
        bridge.processCallback(callbackName, getImageBase64(data.getData()));
    }

    private String getImageBase64(Uri uri) {
        Log.d(TAG, "getImageBase64");
        // Get photo file as bitMap
        InputStream imageStream = null;
        try {
            imageStream = context.getContentResolver().openInputStream(uri);
        } catch (FileNotFoundException e) {
            e.printStackTrace();
        }
        Bitmap bm = BitmapFactory.decodeStream(imageStream);

        // Convert bitmap to byte array
        ByteArrayOutputStream baos = new ByteArrayOutputStream();
        bm.compress(Bitmap.CompressFormat.JPEG, 100, baos); //bm is the bitmap object
        byte[] b = baos.toByteArray();
        return Base64.encodeToString(b, Base64.DEFAULT);
    }
}
\end{lstlisting}

\emph{IntentFactory.java}
\begin{lstlisting}
package pollux.trialbee.com.pollux;

import android.bluetooth.BluetoothAdapter;
import android.content.Context;
import android.content.Intent;
import android.net.Uri;
import android.provider.MediaStore;

import java.io.File;

public class IntentFactory {
    public static Intent createCameraIntent(Context context) {
        // Create the intent for capturing an image
        Intent takePictureIntent = new Intent(MediaStore.ACTION_IMAGE_CAPTURE);

        // Ensure that there's a camera activity to handle the intent
        if (takePictureIntent.resolveActivity(context.getPackageManager()) != null) {
            // Create the File where the photo should go
            File photoFile = AndroidHardware.requestImageFile();
            takePictureIntent.putExtra(MediaStore.EXTRA_OUTPUT,
                    Uri.fromFile(photoFile));
        }
        return takePictureIntent;
    }
    public static Intent createImageIntent(Context context) {
        // Create the intent for picking an image
        Intent getImageIntent = new Intent(Intent.ACTION_PICK);
        getImageIntent.setType("image/*");
        // Ensure that there's a camera activity to handle the intent

        return getImageIntent;
    }
}
\end{lstlisting}
\emph{JavaScriptInterface.java}
\begin{lstlisting}
package pollux.trialbee.com.pollux;

import android.app.Activity;
import android.content.Context;
import android.content.Intent;
import android.net.Uri;
import android.nfc.Tag;
import android.os.Build;
import android.os.Environment;
import android.provider.MediaStore;
import android.util.Log;
import android.webkit.JavascriptInterface;
import android.widget.Toast;

import org.json.JSONObject;

import java.io.File;
import java.io.IOException;

/**
 * Created by dauvid on 2015-02-03.
 */
public class JsInterface {  
    private Bridge bridge;
    private static final String TAG = "JsInterface";

    // Instantiate the interface and set the context
    JsInterface(Bridge bridge) {
        this.bridge = bridge;
    }

    //Request an image from the device camera
    @JavascriptInterface
    public void requestCamera(String callback) {
        Log.d(TAG, "requestImage");
        bridge.requestCamera(callback);
    }

    // Request an image from the device storage
    @JavascriptInterface
    public void requestImage(String callback) {
        Log.d(TAG, "requestImage");
        bridge.requestImage(callback);
    }

    // Request the devices gps-location
    @JavascriptInterface
    public void getGeolocation(String callback) {
        Log.d(TAG, "getGeolocation");
        bridge.getGeolocation(callback);
    }

    @JavascriptInterface
    public void functionCall(String type, String callback) {
        switch (type) {
            case "geolocation":
                getGeolocation(callback);
                break;
            case "camera":
                requestCamera(callback);
                break;
            case "image":
                requestImage(callback);
                break;
            default:
                break;
        }
    }
}
\end{lstlisting}

\emph{MainActivity.java}
\begin{lstlisting}
package pollux.trialbee.com.pollux;

import android.bluetooth.BluetoothDevice;
import android.content.BroadcastReceiver;
import android.content.Context;
import android.content.Intent;
import android.content.IntentFilter;
import android.graphics.Bitmap;
import android.graphics.BitmapFactory;
import android.net.Uri;
import android.os.Bundle;
import android.support.v7.app.ActionBarActivity;
import android.util.Log;
import android.view.View;

import org.json.JSONException;
import org.json.JSONObject;

import java.io.ByteArrayOutputStream;
import java.io.File;
import java.util.HashMap;


public class MainActivity extends ActionBarActivity {
    private HashMap<Integer, Callback> callbacks;
    private UniqueInteger   uniqueInteger;
    private static final String TAG = "MainActivity";
    private Bridge bridge;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        Log.d(TAG, "onCreate");
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);

        bridge = new Bridge(this);
        uniqueInteger = new UniqueInteger();
        callbacks = new HashMap<>();
    }

    @Override
    public void onActivityResult(int requestCode, int resultCode, Intent data) {
        Log.d(TAG, "OnActivityResult");
        Callback cb = callbacks.get(requestCode);
        cb.done(requestCode, resultCode, data);
    }

    public void processIntent(Intent intent, Callback callback) {
        Log.d(TAG, "processIntent");
        int requestCode = uniqueInteger.getUniqueInteger();
        callbacks.put(requestCode, callback);
        startActivityForResult(intent, requestCode);
    }
}
\end{lstlisting}
\emph{UniqueInteger.java}
\begin{lstlisting}
package pollux.trialbee.com.pollux;

import java.util.concurrent.atomic.AtomicInteger;

/**
 * Created by philip on 2015-02-27.
 */
public class UniqueInteger {
    private int uniqueId;

    public UniqueInteger(){
        uniqueId = 0;
    }

    public synchronized int getUniqueInteger(){
        return uniqueId++;
    }

}
\end{lstlisting}
\emph{WebViewDataSender.java}
\begin{lstlisting}
package pollux.trialbee.com.pollux;

import android.os.Build;
import android.util.Log;
import android.webkit.WebSettings;
import android.webkit.WebView;
import android.webkit.WebViewClient;

/**
 * Created by dauvid on 2015-02-20.
 */
public class WebViewDataSender {
    private WebView webView;
    private Bridge bridge;
    private static final String TAG="WebViewDataSender";

    public WebViewDataSender(Bridge b, WebView wV) {
        this.bridge = b;
        webView = wV;
        webView.setWebViewClient(new WebViewClient());

        // Enable javascript
        WebSettings webSettings = webView.getSettings();
        webSettings.setJavaScriptEnabled(true);

        // Enable remote debugging if OS version is high enough
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
            WebView.setWebContentsDebuggingEnabled(true);
        }

        // Add javascript interface
        webView.addJavascriptInterface(new JsInterface(bridge), "Android");

        // Load pollux server page on "http://pollux-server.heroku.com"
        webView.post(new Runnable() {
            @Override
            public void run() {
                webView.loadUrl("http://pollux-server.heroku.com");
            }
        });
    }

    public void sendData(final String javascriptFunction, final String arg) {
        Log.d(TAG, "sendData");
        webView.post(new Runnable() {
            @Override
            public void run() {
                webView.loadUrl("javascript:" + javascriptFunction + "('" + arg + "')");
            }
        });
    }
}
\end{lstlisting}

\newpage
\section{Mobile application developed using PhoneGap} \label{App:AppendixB}
\emph{app.js}
\begin{lstlisting}[language=JavaScript]
/*
 * Licensed to the Apache Software Foundation (ASF) under one
 * or more contributor license agreements.  See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership.  The ASF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License.  You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

var app = {
  // Application Constructor
  initialize: function() {
    this.bindEvents();  
  },
  // Bind Event Listeners
  //
  // Bind any events that are required on startup. Common events are:
  // 'load', 'deviceready', 'offline', and 'online'.
  bindEvents: function() {
    document.addEventListener('deviceready', this.onDeviceReady, false);
  },
  // deviceready Event Handler
  //
  // The scope of 'this' is the event. In order to call the 'receivedEvent'
  // function, we must explicitly call 'app.receivedEvent(...);'
  onDeviceReady: function() {
    // Add messege listener
    $(document).ready(function () {
      PolluxReceiver.addMessageListener();
      LocalDevice.initiateWebApp();
    });
  }
};
\end{lstlisting}
\emph{device.js}
\begin{lstlisting}[language=JavaScript]
// Relay function calls to
var Pollux       = null;
var PolluxDevice = null;

// Contains functions for camera API calls
var DeviceCamera = new function() {
  var self = this;

  self.currentCallback = null;
  // Requests image from camera
  self.getPicture = function(callbackName) {
    console.log("Phonegap bridge: getPicture");
    self.currentCallback = callbackName;

    navigator.camera.getPicture(
      this.onSuccess,
      this.onFail,
      {
        destinationType: Camera.DestinationType.DATA_URL
      }
    );
  };

  // Requests image from photolibrary
  self.uploadPicture = function(callbackName) {
    console.log("Phonegap bridge: uploadPicture");
    self.currentCallback = callbackName;

    navigator.camera.getPicture(
      self.onSuccess,
      self.onFail,
      {
        destinationType: Camera.DestinationType.DATA_URL,
        sourceType: Camera.PictureSourceType.PHOTOLIBRARY
      }
    );
  };

  // Called upon successful image requests
  self.onSuccess = function(imageData) {
    console.log("Phonegap, bridge: cameraSuccess");
    PolluxDevice.deviceCallback(imageData, self.currentCallback);
  },

  // Called upon failed image requests
  self.onFail = function() {
    console.log(" Phonegap, bridge: cameraError");
    alert("Phonegap, bridge: cameraError");
  }
};

var LocalDevice = {
  // Load webapplication and initiate to phonegap behavior on completion
  initiateWebApp: function () {
     // Wait for iFrame to load before initiating to phonegap behavior
     $('#web-context').load(function(){
      console.log('PhoneGap, bridge, iframe loaded');
      var polluxWindow = document.getElementById('web-context').contentWindow;
      Pollux = polluxWindow.Pollux;
      PolluxDevice = Pollux.setDevice('phonegap', function(){
        polluxWindow.document.getElementById('captured-video').style.display = "none";
      });
     });
     // Load webapplication
     $('#web-context').attr({
      src: 'http://pollux-server.herokuapp.com'
      //src: 'http://192.168.0.100:3000'
    });
  }
};
    // Deprecated method
// Contains functions for Geolocation API calls
var geolocation = new function () {
  var self = this;

  self.currentCallback = null;
  // Request geolocation
  self.getGeolocation = function(callbackName){
    console.log("Phonegap bridge: getGeolocation");
    self.currentCallback = callbackName;
    navigator.geolocation.getCurrentPosition(self.onSuccess, self.onError, {timeout: 10000});
  },

  // Called upon successful geolocation requests
  self.onSuccess = function(position) {
    console.log("Phonegap, bridge: geolocation success");
    console.log('phonegap, bridge'          + '\n' +
      'Latitude: '          + position.coords.latitude          + '\n' +
      'Longitude: '         + position.coords.longitude         + '\n' +
      'Altitude: '          + position.coords.altitude          + '\n' +
      'Accuracy: '          + position.coords.accuracy          + '\n' +
      'Altitude Accuracy: ' + position.coords.altitudeAccuracy  + '\n' +
      'Heading: '           + position.coords.heading           + '\n' +
      'Speed: '             + position.coords.speed             + '\n' +
      'Timestamp: '         + position.timestamp                + '\n');

    var locationData = JSON.stringify({
      latitude: position.coords.latitude,
      longitude: position.coords.longitude
    });
    PolluxDevice.deviceCallback(locationData, self.currentCallback);
  },

  // Called upon failed geolocation requests
  self.onError = function(error) {
    console.log("Phonegap, bridge: geolocation error");
    alert('code: '    + error.code    + '\n' +
      'message: ' + error.message + '\n');
  }
};
\end{lstlisting}
\emph{receiver.js}
\begin{lstlisting}[language=JavaScript]
var PolluxReceiver = {
  // Register message listener
  addMessageListener: function() {
    window.addEventListener('message', this.messageReceived, false);
    console.log('phonegap: added eventlistener to phonegap');
  },

  // Called upon receiving message
  messageReceived: function(message) {
    var messageAsJSON = JSON.parse(message.data);
    var type          = messageAsJSON.type;
    var callbackName  = messageAsJSON.callbackName;

    console.log('phonegap receiver: messageReceived - ' + messageAsJSON);

    if (type === 'camera') {
      console.log('phonegap, receiver: received camera request from browser');
      DeviceCamera.getPicture(callbackName);

    } else if (type === 'image') {
      console.log('phonegap, receiver: received image request from browser');
      DeviceCamera.uploadPicture(callbackName);

    } else if (type === 'geolocation') {
      console.log('phonegap, receiver: received geolocation request from browser');
      geolocation.getGeolocation(callbackName);

    } else {
      console.log('phonegap, receiver: request with unknown type recived');
      alert(message.data);
    }
  }
};
\end{lstlisting}

\newpage

\section{Web application developed for Android SDK version} \label{App:AppendixC}
% the \\ insures the section title is centered below the phrase: Appendix B
\emph{application.js}
\begin{lstlisting}[language=JavaScript]
// This is a manifest file that'll be compiled into application.js, which will include all the files
// listed below.
//
// Any JavaScript/Coffee file within this directory, lib/assets/javascripts, vendor/assets/javascripts,
// or any plugin's vendor/assets/javascripts directory can be referenced here using a relative path.
//
// It's not advisable to add code directly here, but if you do, it'll appear at the bottom of the
// compiled file.
//
// Read Sprockets README (https://github.com/sstephenson/sprockets#sprockets-directives) for details
// about supported directives.
//
//= require jquery
//= require jquery_ujs
//= require_tree .

function debug(msg) {
  if (typeof console == 'undefined' || typeof console.log == 'undefined')
    return;

  if (typeof msg !== 'string' && typeof JSON !== 'undefined')
    msg = JSON.stringify(msg);

  console.log('DEBUG: ' + msg);
}

$(document).ready(function() {
  var localMediaStream = null;

  $('#take-picture').on('click', function(e) {
    e.preventDefault();
    Pollux.device.requestCamera('addImgBase64');
  });

  $('#upload-image').on('click', function(e) {
    e.preventDefault();
    Pollux.device.uploadImage('addImgBase64');
  });

  $('#add-location').on('click', function(e) {
    e.preventDefault();
    Pollux.device.getGeoLocation("showLocation");

  });
});



function showLocation(location){
  var locationJSON = JSON.parse(location);
  var setLocationDataPoint = function($element, dataPoint) {
    $element.show();
    $element.empty();
    $element.append(dataPoint);
  };

  setLocationDataPoint($('#longitude-location'), "Longitude: " + locationJSON.longitude);
  setLocationDataPoint($('#latitude-location'), "Latitude: " + locationJSON.latitude);
}

function addImgBase64(base64) {
  debug('web client, application.js, function: addImgBase64');
  var imageData = null;
  if (base64.substring(0, 10) === 'data:image') {
    imageData = base64;
  } else {
    imageData = 'data:image/jpeg;base64,' + base64;
  }
  $('#captured-image').attr('src', imageData);
}
\end{lstlisting}
\emph{device.js}
\begin{lstlisting}[language=JavaScript]
(function (window) {
  'use strict';

  var adapterCallback = function(context, callback) {
    if (typeof callback === 'function') {
      callback(context);
    }
  };

  var executeFunctionByName = function(functionName, context /*, args */) {
    var args       = [].slice.call(arguments).splice(2);
    var namespaces = functionName.split('.');
    var func       = namespaces.pop();
    for(var i = 0; i < namespaces.length; i++) {
      context = context[namespaces[i]];
    }
    return context[func].apply(this, args);
  }

  var debug = function(msg) {
    if (typeof console == 'undefined' || typeof console.log == 'undefined') {
      return;
    }

    if (typeof msg !== 'string' && typeof JSON !== 'undefined') {
      msg = JSON.stringify(msg);
    }

    console.log('DEBUG: ' + msg);
  };

  var PolluxDeviceFactory = function() {
    var device = null;

    if (typeof Android !== 'undefined') {
      debug('Running on a native Android device.');
      device = new AndroidDeviceAdapter(
        function(){
          document.getElementById('captured-video').style.display = "none";
        }
      );
    } else {
      debug('Running in webbrowser');
      device = new WebDeviceAdapter();
    }

    return device;
  };

  var AndroidDeviceAdapter = function(callback) {
    var self        = this;
    self.client     = Android;
    self.deviceType = 'android';

    self.requestCamera = function(callback) {
      self.client.requestCamera(callback);
    };

    self.uploadImage = function(callback) {
      self.client.requestImage(callback);
    };

    self.getGeoLocation = function(callback) {
      self.client.getGeolocation(callback);
    };

    adapterCallback(self, callback);
    return self;
  };

  var WebDeviceAdapter = function(callback) {
    var self        = this;
    self.deviceType = 'web';

    navigator.getUserMedia = (navigator.getUserMedia       ||
                              navigator.webkitGetUserMedia ||
                              navigator.mozGetUserMedia    ||
                              navigator.msGetUserMedia);

    self.uploadImage = function() {
      $('#fileUpload').click();
      
      $('#fileUpload').change(function(){
        var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.jpg|.jpeg|.gif|.png|.bmp)$/;
        if (regex.test($(this).val().toLowerCase())) {
          if (typeof (FileReader) != "undefined") {
            var reader = new FileReader();
            reader.onload = function (e) {
              $("#captured-image").attr("src", e.target.result);
            }
            reader.readAsDataURL($(this)[0].files[0]);
          } else {
            alert("This browser does not support FileReader.");
          }
      } else {
          alert("Please upload a valid image file.");
        }
      });
    };

    self.requestCamera = function(callbackName) {
      
      var takePicture = function(video) {
        overlay("Capture", "capture-from-video", function(){
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          self.deviceCallback(canvas.toDataURL('image/webp'), callbackName);
        });
      };

      var streamVideo = function(callback){
        if (navigator.getUserMedia) {
          navigator.getUserMedia(
            // constraints
            {
              video: true,
              audio: false
            },
            // successCallback
            function(stream) {
              var vendorUrl = window.URL || window.webkitURL;
              var src       = vendorUrl.createObjectURL(stream);
              callback(src, stream);
            },
            // errorCallback
            function(err) {
            }
          );
        } else {
        }
      };

      var overlay = function(overlayText, id, callback){

        var id         = id;
        var overlayTag = '<a href="#" class="video-overlay" id="' + id + '">' + overlayText + '</a>';
        var video      = document.querySelector("#captured-video");
        $(video).after(overlayTag);
        $('#' + id).click(function(e) {
          if(typeof callback !== 'undefined'){
            callback();
          }
          e.preventDefault();
          video.src="";
          $('#' + id).remove();
        });
      };

      var id      = 'captured-image-canvas';
      var canvas  = document.querySelector(id);
      var body    = null;
      var element = null;
      var ctx     = null;

      if (canvas === null) {
        body   = document.querySelector('body');
        canvas = document.createElement('canvas');
        canvas.id            = id;
        canvas.style.display = 'none';
        body.appendChild(canvas);
      }
      ctx = canvas.getContext('2d');
      
      streamVideo(function(src, stream) {
        var video = document.querySelector('#captured-video');
        video.src = src;
        video.play();

        takePicture(video);
      });
    };

    self.getGeoLocation = function(callbackName) {
      navigator.geolocation.getCurrentPosition(function(geolocation){
        var locationJSON = {
          longitude: geolocation.coords.longitude,
          latitude: geolocation.coords.latitude
        };
        deviceCallback(JSON.stringify(locationJSON), callbackName);
      });
    };

    self.deviceCallback = function(data, callbackName) {
      executeFunctionByName(callbackName, window, data);
    };

    adapterCallback(self, callback);
    return self;
  };

  var Pollux = function(device) {
    var self    = this;
    self.device = null;
    $(document).ready(function () {  
      self.device = new PolluxDeviceFactory();
      return self;
      });
  };

  window.Pollux = new Pollux();
}(window));
\end{lstlisting}

\newpage

\section{Web application developed for PhoneGap version} \label{App:AppendixD}
% the \\ insures the section title is centered below the phrase: Appendix B
\emph{application.js}
\begin{lstlisting}[language=JavaScript]
// This is a manifest file that'll be compiled into application.js, which will include all the files
// listed below.
//
// Any JavaScript/Coffee file within this directory, lib/assets/javascripts, vendor/assets/javascripts,
// or any plugin's vendor/assets/javascripts directory can be referenced here using a relative path.
//
// It's not advisable to add code directly here, but if you do, it'll appear at the bottom of the
// compiled file.
//
// Read Sprockets README (https://github.com/sstephenson/sprockets#sprockets-directives) for details
// about supported directives.
//
//= require jquery
//= require jquery_ujs
//= require_tree .

function debug(msg) {
  if (typeof console == 'undefined' || typeof console.log == 'undefined')
    return;

  if (typeof msg !== 'string' && typeof JSON !== 'undefined')
    msg = JSON.stringify(msg);

  console.log('DEBUG: ' + msg);
}

$(document).ready(function() {
  var localMediaStream = null;

  $('#take-picture').on('click', function(e) {
    e.preventDefault();
    Pollux.device.requestCamera('addImgBase64');
  });

  $('#upload-image').on('click', function(e) {
    e.preventDefault();
    Pollux.device.uploadImage('addImgBase64');
  });

  $('#add-location').on('click', function(e) {
    e.preventDefault();
    Pollux.device.getGeoLocation("showLocation");

  });
});



function showLocation(location){
  var locationJSON = JSON.parse(location);
  var setLocationDataPoint = function($element, dataPoint) {
    $element.show();
    $element.empty();
    $element.append(dataPoint);
  };

  setLocationDataPoint($('#longitude-location'), "Longitude: " + locationJSON.longitude);
  setLocationDataPoint($('#latitude-location'), "Latitude: " + locationJSON.latitude);
}

function addImgBase64(base64) {
  debug('web client, application.js, function: addImgBase64');
  var imageData = null;
  if (base64.substring(0, 10) === 'data:image') {
    imageData = base64;
  } else {
    imageData = 'data:image/jpeg;base64,' + base64;
  }
  $('#captured-image').attr('src', imageData);
}
\end{lstlisting}
\emph{device.js}
\begin{lstlisting}[language=JavaScript]
(function (window) {
  'use strict';

  var adapterCallback = function(context, callback) {
    if (typeof callback === 'function') {
      callback(context);
    }
  };

  var executeFunctionByName = function(functionName, context /*, args */) {
    var args       = [].slice.call(arguments).splice(2);
    var namespaces = functionName.split('.');
    var func       = namespaces.pop();
    for(var i = 0; i < namespaces.length; i++) {
      context = context[namespaces[i]];
    }
    return context[func].apply(this, args);
  }

  var debug = function(msg) {
    if (typeof console == 'undefined' || typeof console.log == 'undefined') {
      return;
    }

    if (typeof msg !== 'string' && typeof JSON !== 'undefined') {
      msg = JSON.stringify(msg);
    }

    console.log('DEBUG: ' + msg);
  };

  var PolluxDeviceFactory = function() {
    debug('Running in webbrowser');
    device = new WebDeviceAdapter();
    return device;
  };

  var PhoneGapDeviceAdapter = function(callback) {
    var self        = this;
    self.deviceType = 'phonegap';
    self.phonegap   = window.parent;

    self.requestCamera = function(callbackName) {
      debug('webclient, bridge: requestCamera');
      self.send('camera', callbackName);
    };

    self.uploadImage = function(callbackName) {
      debug('webclient, bridge: requestImage');
      self.send('image', callbackName);
    };

    self.getGeoLocation = function(callbackName) {
      self.send('geolocation', callbackName);
    };

    self.deviceCallback = function(data, callbackName) {
      executeFunctionByName(callbackName, window, data);
    };

    self.send = function(requestType, callbackName) {
      var jsonRequest = JSON.stringify({
        type:         requestType,
        callbackName: callbackName
      });
      self.phonegap.postMessage(jsonRequest, 'file://');
    };

    adapterCallback(self, callback);
    return self;
  };

  var WebDeviceAdapter = function(callback) {
    var self        = this;
    self.deviceType = 'web';

    navigator.getUserMedia = (navigator.getUserMedia       ||
                              navigator.webkitGetUserMedia ||
                              navigator.mozGetUserMedia    ||
                              navigator.msGetUserMedia);

    self.uploadImage = function() {
      $('#fileUpload').click();
      
      $('#fileUpload').change(function(){
        var regex = /^([a-zA-Z0-9\s_\\.\-:])+(.jpg|.jpeg|.gif|.png|.bmp)$/;
        if (regex.test($(this).val().toLowerCase())) {
          if (typeof (FileReader) != "undefined") {
            var reader = new FileReader();
            reader.onload = function (e) {
              $("#captured-image").attr("src", e.target.result);
            }
            reader.readAsDataURL($(this)[0].files[0]);
          } else {
            alert("This browser does not support FileReader.");
          }
      } else {
          alert("Please upload a valid image file.");
        }
      });
    };

    self.requestCamera = function(callbackName) {
      
      var takePicture = function(video) {
        overlay("Capture", "capture-from-video", function(){
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          self.deviceCallback(canvas.toDataURL('image/webp'), callbackName);
        });
      };

      var streamVideo = function(callback){
        if (navigator.getUserMedia) {
          navigator.getUserMedia(
            // constraints
            {
              video: true,
              audio: false
            },
            // successCallback
            function(stream) {
              var vendorUrl = window.URL || window.webkitURL;
              var src       = vendorUrl.createObjectURL(stream);
              callback(src, stream);
            },
            // errorCallback
            function(err) {
            }
          );
        } else {
        }
      };

      var overlay = function(overlayText, id, callback){

        var id         = id;
        var overlayTag = '<a href="#" class="video-overlay" id="' + id + '">' + overlayText + '</a>';
        var video      = document.querySelector("#captured-video");
        $(video).after(overlayTag);
        $('#' + id).click(function(e) {
          if(typeof callback !== 'undefined'){
            callback();
          }
          e.preventDefault();
          video.src="";
          $('#' + id).remove();
        });
      };

      var id      = 'captured-image-canvas';
      var canvas  = document.querySelector(id);
      var body    = null;
      var element = null;
      var ctx     = null;

      if (canvas === null) {
        body   = document.querySelector('body');
        canvas = document.createElement('canvas');
        canvas.id            = id;
        canvas.style.display = 'none';
        body.appendChild(canvas);
      }
      ctx = canvas.getContext('2d');
      
      streamVideo(function(src, stream) {
        var video = document.querySelector('#captured-video');
        video.src = src;
        video.play();

        takePicture(video);
      });
    };

    self.getGeoLocation = function(callbackName) {
      navigator.geolocation.getCurrentPosition(function(geolocation){
        var locationJSON = {
          longitude: geolocation.coords.longitude,
          latitude: geolocation.coords.latitude
        };
        deviceCallback(JSON.stringify(locationJSON), callbackName);
      });
    };

    self.deviceCallback = function(data, callbackName) {
      executeFunctionByName(callbackName, window, data);
    };

    adapterCallback(self, callback);
    return self;
  };

  var Pollux = function(device) {
    var self    = this;
    self.device = null;

     // Called when running on PhoneGap
    self.setDevice = function(deviceName, callback) {
      if (deviceName === 'phonegap') {
        self.device = new PhoneGapDeviceAdapter(callback);
        debug('web client, device: set to PhoneGapDevice');
      } else if (deviceName === 'web') {
        self.device = new WebDeviceAdapter(callback);
        debug('web client, device: set to WebDevice');
      }
      return self.device;
    };
    $(document).ready(function () {  
      self.device = new PolluxDeviceFactory();
      return self;
    });
  };
  window.Pollux = new Pollux();
}(window));
\end{lstlisting}

\newpage